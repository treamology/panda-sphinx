

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Simple Environment Mapping &mdash; Panda3D Manual</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Panda3D Manual" href="../../index.html"/>
        <link rel="up" title="Texturing" href="index.html"/>
        <link rel="next" title="3-D Textures" href="3d-textures.html"/>
        <link rel="prev" title="Projected Textures" href="projected-textures.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Panda3D
          

          
          </a>

          
            
            
              <div class="version">
                1.10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../intro/index.html">Introduction to Panda3D</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Programming with Panda3D</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../the-scene-graph/index.html">The Scene Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../the-configuration-file/index.html">The Configuration File</a></li>
<li class="toctree-l2"><a class="reference internal" href="../models-and-actors/index.html">Models and Actors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../render-attributes/index.html">Render Attributes</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Texturing</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="simple-texturing.html">Simple Texturing</a></li>
<li class="toctree-l3"><a class="reference internal" href="choosing-a-texture-size.html">Choosing a Texture Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-wrap-modes.html">Texture Wrap Modes</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-filter-types.html">Texture Filter Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="simple-texture-replacement.html">Simple Texture Replacement</a></li>
<li class="toctree-l3"><a class="reference internal" href="multitexture-introduction.html">Multitexture Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-modes.html">Texture Modes</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-order.html">Texture Order</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-combine-modes.html">Texture Combine Modes</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-transforms.html">Texture Transforms</a></li>
<li class="toctree-l3"><a class="reference internal" href="multiple-texture-coordinate-sets.html">Multiple Texture Coordinate Sets</a></li>
<li class="toctree-l3"><a class="reference internal" href="automatic-texture-coordinates.html">Automatic Texture Coordinates</a></li>
<li class="toctree-l3"><a class="reference internal" href="projected-textures.html">Projected Textures</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Simple Environment Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="3d-textures.html">3-D Textures</a></li>
<li class="toctree-l3"><a class="reference internal" href="cube-maps.html">Cube Maps</a></li>
<li class="toctree-l3"><a class="reference internal" href="environment-mapping-with-cube-maps.html">Environment Mapping with Cube Maps</a></li>
<li class="toctree-l3"><a class="reference internal" href="automatic-texture-animation.html">Automatic Texture Animation</a></li>
<li class="toctree-l3"><a class="reference internal" href="playing-mpg-and-avi-files.html">Playing MPG and AVI files</a></li>
<li class="toctree-l3"><a class="reference internal" href="stereo-multiview-textures.html">Stereo/Multiview Textures</a></li>
<li class="toctree-l3"><a class="reference internal" href="transparency-and-blending.html">Transparency and Blending</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-management.html">Texture Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="texture-compression.html">Texture Compression</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../shaders/index.html">Shaders</a></li>
<li class="toctree-l2"><a class="reference internal" href="../camera-control/index.html">Camera Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sound/index.html">Sound</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intervals/index.html">Intervals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tasks-and-event-handling/index.html">Tasks and Event Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../text-and-image-rendering/index.html">Text and Image Rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../directgui/index.html">DirectGUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../render-effects/index.html">Render Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../finite-state-machines/index.html">Finite State Machines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../terrain/index.html">Terrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-structures/index.html">Advanced operations with Panda3D&#8217;s internal structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../render-to-texture-and-image-postprocessing/index.html">Render-to-Texture and Image Postprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../panda3d-rendering-process/index.html">Panda3D Rendering Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../panda3d-utility-functions.html">Panda3D Utility Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../particle-effects/index.html">Particle Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collision-detection/index.html">Collision Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../garbage-collection/index.html">Garbage Collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware-support/index.html">Hardware support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../math-engine/index.html">Math Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../physics/index.html">Physics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../motion-paths.html">Motion Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timing/index.html">Timing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networking/index.html">Networking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multifiles/index.html">Multifiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../showbase.html">ShowBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file-reading.html">File Reading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threading.html">Threading</a></li>
<li class="toctree-l2"><a class="reference internal" href="../subclassing.html">Subclassing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../table-of-features-supported-per-graphic-renderer.html">Table of features supported per graphic renderer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pandai/index.html">Artificial Intelligence (PANDAI)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../distribution/index.html">Distributing Panda3D Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/index.html">Sample Programs in the Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debugging/index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance-tuning/index.html">Performance Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../using-c++/index.html">Using C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Panda3D Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../building-from-source.html">Building Panda3D from Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cheat-sheets.html">Cheat Sheets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started-on-osx.html">Getting Started on OSX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../more-panda3d-resources.html">More Panda3D Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thirdparty-licenses.html">Third-party dependencies and license info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../the-irc-channel.html">The IRC Channel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Panda3D</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Programming with Panda3D</a> &raquo;</li>
      
          <li><a href="index.html">Texturing</a> &raquo;</li>
      
    <li>Simple Environment Mapping</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/programming-with-panda3d/texturing/simple-environment-mapping.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="simple-environment-mapping">
<span id="id1"></span><h1>Simple Environment Mapping<a class="headerlink" href="#simple-environment-mapping" title="Permalink to this headline">Â¶</a></h1>
<p>There is a classic technique in real-time computer graphics for making objects
appear shiny or reflective. It&#8217;s called environment mapping or sometimes
reflection mapping or, in this case, sphere mapping.</p>
<p>Environment mapping is not ray tracing. But it&#8217;s a cheesy way to get a similar
effect. The idea for both of them is that, mathematically, it&#8217;s easy to
calculate the direction from which a ray of light must have been coming before
it bounced off a particular point of a shiny object and entered your eye. If
the renderer were using ray tracing, it would follow this ray, for each point
on your shiny object, backwards from your eye, and determine what object in
the environment the ray came from; and that&#8217;s what you&#8217;d see in the
reflection.</p>
<p>Ray tracing is still too computation-intensive to be done in real time. But a
reflection vector is easy to calculate per-vertex, and if we could turn a
reflection vector into a (u, v) texture coordinate pair, the graphics hardware
is particularly good at looking up the color in a texture image that
corresponds to that (u, v) pair. So all we need is an image that shows the
objects in our environment.</p>
<p>In sphere mapping, the 3-D reflection vector is turned into a 2-D texture
coordinate pair by mathematically applying a spherical distortion. This means
the environment map should be a view of the world as seen through a 360-degree
fisheye lens, or as reflected in a shiny ball like a holiday ornament. You can
see why it is called sphere mapping.</p>
<p><img alt="bvw-f2004--streetscene as a sphere map" src="../../_images/streetscene-env.jpg" /></p>
<p>Panda3D can generate sphere maps for you. The above sphere map was generated
with the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">scene</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadModel</span><span class="p">(</span><span class="s1">&#39;bvw-f2004--streetscene/street-scene.egg&#39;</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">reparentTo</span><span class="p">(</span><span class="n">render</span><span class="p">)</span>
<span class="n">scene</span><span class="o">.</span><span class="n">setZ</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">base</span><span class="o">.</span><span class="n">saveSphereMap</span><span class="p">(</span><span class="s1">&#39;streetscene_env.jpg&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span>
</pre></div>
</div>
<p>The idea is simply to put the camera in the middle of your environment,
approximately where your shiny object would be. Then just call
<code class="docutils literal"><span class="pre">base.saveSphereMap()</span></code>, and a suitable sphere
map image will be generated and written to disk for you. Note that this
feature is new as of Panda3D 1.1.</p>
<p>Now you can apply the environment map to just about any object you like. For
instance, the teapot:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tex</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadTexture</span><span class="p">(</span><span class="s1">&#39;streetscene_env.jpg&#39;</span><span class="p">)</span>
<span class="n">teapot</span><span class="o">.</span><span class="n">setTexGen</span><span class="p">(</span><span class="n">TextureStage</span><span class="o">.</span><span class="n">getDefault</span><span class="p">(),</span> <span class="n">TexGenAttrib</span><span class="o">.</span><span class="n">MEyeSphereMap</span><span class="p">)</span>
<span class="n">teapot</span><span class="o">.</span><span class="n">setTexture</span><span class="p">(</span><span class="n">tex</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="The teapot with sphere map" src="../../_images/chrome-teapot.jpg" /></p>
<p>In this example, you can see that the key to sphere mapping in Panda is to set
the <a class="reference internal" href="automatic-texture-coordinates.html#automatic-texture-coordinates"><span class="std std-ref">TexGen mode</span></a> to MEyeSphereMap. This
mode computes a spherical (u, v) texture coordinate pair based on the
reflection vector for each vertex of the teapot. In order for this to work,
your model must have normals defined for all its vertices (the teapot has good
normals).</p>
<p>Shiny teapots are one thing, but it would be nice to make something like, say,
a car look shiny. We could just do exactly the same thing as above, but our
car has a texture map already. If we just replace the texture map with the
environment map we&#8217;ll end up with a chrome car:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">car</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadModel</span><span class="p">(</span><span class="s1">&#39;bvw-f2004--carnsx/carnsx.egg&#39;</span><span class="p">)</span>
<span class="n">tex</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadTexture</span><span class="p">(</span><span class="s1">&#39;streetscene_env.jpg&#39;</span><span class="p">)</span>
<span class="n">car</span><span class="o">.</span><span class="n">setTexGen</span><span class="p">(</span><span class="n">TextureStage</span><span class="o">.</span><span class="n">getDefault</span><span class="p">(),</span> <span class="n">TexGenAttrib</span><span class="o">.</span><span class="n">MEyeSphereMap</span><span class="p">)</span>
<span class="n">car</span><span class="o">.</span><span class="n">setTexture</span><span class="p">(</span><span class="n">tex</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="The car with sphere map" src="../../_images/chrome-car.jpg" /></p>
<p>That looks pretty silly. So we&#8217;d really prefer to use
<a class="reference internal" href="multitexture-introduction.html#multitexture-introduction"><span class="std std-ref">multitexture</span></a> to apply both the car&#8217;s
regular texture, and layer a little bit of shine on top of that. We&#8217;ll use
<a class="reference internal" href="texture-modes.html#texture-modes"><span class="std std-ref">Add mode</span></a> to add the environment map to the existing
color, which is appropriate for a shiny highlight on an object.</p>
<p>In order to use Add mode without oversaturating the colors, we need to darken
the environment map substantially. We could use any image processing program
to do this; for this example, we&#8217;ll use Panda3D&#8217;s
<code class="docutils literal"><span class="pre">image-trans</span></code> utility:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">image</span><span class="o">-</span><span class="n">trans</span> <span class="o">-</span><span class="n">cscale</span> <span class="mf">0.2</span> <span class="o">-</span><span class="n">o</span> <span class="n">streetscene_env_dark</span><span class="o">.</span><span class="n">jpg</span> <span class="n">streetscene_env</span><span class="o">.</span><span class="n">jpg</span>
</pre></div>
</div>
<p>So the new map looks like this:</p>
<p><img alt="The darkened environment map" src="../../_images/streetscene-env-dark.jpg" /></p>
<p>While we&#8217;re fixing things up, let&#8217;s move the wheels to a different node, so we
can assign the shine just to the metal and glass body of the car:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">car</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadModel</span><span class="p">(</span><span class="s1">&#39;bvw-f2004--carnsx/carnsx.egg&#39;</span><span class="p">)</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">car</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;**/body&#39;</span><span class="p">)</span>
<span class="n">body</span><span class="o">.</span><span class="n">findAllMatches</span><span class="p">(</span><span class="s1">&#39;**/FL_wheel*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reparentTo</span><span class="p">(</span><span class="n">car</span><span class="p">)</span>
</pre></div>
</div>
<p>And now the shine is applied like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tex</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">loadTexture</span><span class="p">(</span><span class="s1">&#39;streetscene_env_dark.jpg&#39;</span><span class="p">)</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">TextureStage</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">)</span>
<span class="n">ts</span><span class="o">.</span><span class="n">setMode</span><span class="p">(</span><span class="n">TextureStage</span><span class="o">.</span><span class="n">MAdd</span><span class="p">)</span>
<span class="n">body</span><span class="o">.</span><span class="n">setTexGen</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">TexGenAttrib</span><span class="o">.</span><span class="n">MEyeSphereMap</span><span class="p">)</span>
<span class="n">body</span><span class="o">.</span><span class="n">setTexture</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">tex</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="The car with color and shine together" src="../../_images/shiny-car.jpg" /></p>
<p>Note that the shiny highlights are now quite subtle, but still compelling,
especially when you see the car move.</p>
<p>The sphere map technique isn&#8217;t perfect. The biggest problem with it is that
you have to prepare it ahead of time, which means you have to know exactly
what will be reflected in your shiny objects&#8211;it&#8217;s impossible for an object to
reflect a dynamic object (for instance, an adjacent car).</p>
<p>Another problem is that the point-of-view is baked into the sphere map, so
that if the camera were to swing around to view the car from the other side,
the things you could see in the reflection would still be the objects behind
the camera on this side.</p>
<p>Both of these problems can be solved by <a class="reference internal" href="cube-maps.html#cube-maps"><span class="std std-ref">cube mapping</span></a>, which
is a more advanced technique for, among other things, applying environment
maps. However, cube maps aren&#8217;t always ideal; very often, the venerable sphere
map really is the best choice.</p>
<p>It is rare that an application presents a closeup view of a smooth, round
mirrored object in which you can see reflections clearly, like the teapot
example above; usually, reflections are just a subtle glinting on the surface,
like the car. In these cases the sphere map is ideal, since it is not so
important exactly what the reflections are, but simply that there are
reflections. And the sphere map is the easiest and fastest way to render
reflections.</p>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="3d-textures.html" class="btn btn-neutral float-right" title="3-D Textures" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="projected-textures.html" class="btn btn-neutral" title="Projected Textures" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Panda3D.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.10.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>